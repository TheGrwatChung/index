<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jedi Fluid - GitHub Pages Stable Version</title>
    <style>
        body { margin: 0; padding: 0; background-color: #000; overflow: hidden; font-family: sans-serif; }
        canvas { width: 100vw; height: 100vh; display: block; }
        #ui-layer {
            position: absolute; top: 20px; left: 20px; color: #00d2ff;
            pointer-events: none; text-shadow: 0 0 8px #00d2ff; z-index: 10;
        }
        .status-dot {
            display: inline-block; width: 10px; height: 10px;
            background: #ff0000; border-radius: 50%; margin-right: 5px;
        }
        .active { background: #00ff00; box-shadow: 0 0 8px #00ff00; }
        #video-input {
            position: absolute; bottom: 10px; right: 10px;
            width: 120px; height: 90px; border: 1px solid #444;
            transform: scaleX(-1); background: #000; z-index: 5;
        }
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: black; display: flex; flex-direction: column;
            justify-content: center; align-items: center; color: white; z-index: 100;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #333;
            border-top: 4px solid #00d2ff; border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #error-msg { color: #ff4444; margin-top: 15px; text-align: center; max-width: 80%; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <p id="loading-text">正在召喚原力... (載入模型中)</p>
        <div id="error-msg"></div>
    </div>

    <div id="ui-layer">
        <h2>LIGHTSABER FLUID</h2>
        <p><span id="status-dot" class="status-dot"></span> 狀態: <span id="status-text">初始化中...</span></p>
    </div>

    <video id="video-input" playsinline></video>
    <canvas id="fluid-canvas"></canvas>

    <!-- 載入 MediaPipe 資源 -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    
    <!-- 載入流體引擎 (使用穩定 CDN) -->
    <script src="https://unpkg.com/webgl-fluid-simulation@1.0.1/dist/webgl-fluid-simulation.js"></script>

    <script>
        window.addEventListener('load', async () => {
            const videoElement = document.getElementById('video-input');
            const canvasElement = document.getElementById('fluid-canvas');
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            const loadingOverlay = document.getElementById('loading-overlay');
            const errorMsg = document.getElementById('error-msg');

            let lastX = 0, lastY = 0;

            // 1. 初始化流體引擎
            try {
                if (typeof fluidSimulation === 'function') {
                    fluidSimulation({
                        canvas: canvasElement,
                        DENSITY_DISSIPATION: 0.98,
                        VELOCITY_DISSIPATION: 0.99,
                        SPLAT_RADIUS: 0.28,
                        COLORFUL: false,
                        BACK_COLOR: { r: 0, g: 0, b: 0 }
                    });
                } else {
                    throw new Error("流體引擎腳本載入不完全");
                }
            } catch (e) {
                errorMsg.innerText = "流體引擎載入失敗，請檢查網路。";
                return;
            }

            // 2. 初始化手部追蹤
            const hands = new Hands({
                locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                }
            });

            hands.setOptions({
                maxNumHands: 1,
                modelComplexity: 1,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });

            hands.onResults((results) => {
                // 成功抓到結果後關閉載入畫面
                if (loadingOverlay.style.display !== 'none') {
                    loadingOverlay.style.display = 'none';
                }

                if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                    statusDot.classList.add('active');
                    statusText.innerText = "已偵測到食指";

                    const tip = results.multiHandLandmarks[0][8]; // 食指尖
                    const tx = (1 - tip.x) * window.innerWidth;
                    const ty = tip.y * window.innerHeight;
                    
                    const dx = tx - lastX;
                    const dy = ty - lastY;

                    if (window.splat) {
                        // 絕地藍色效果
                        window.splat(tx, ty, dx * 6, dy * 6, { r: 0, g: 0.7, b: 1.0 });
                    }
                    lastX = tx; lastY = ty;
                } else {
                    statusDot.classList.remove('active');
                    statusText.innerText = "請將手舉到鏡頭前";
                }
            });

            // 3. 啟動相機
            const camera = new Camera(videoElement, {
                onFrame: async () => {
                    await hands.send({ image: videoElement });
                },
                width: 640,
                height: 480
            });

            camera.start().catch(err => {
                errorMsg.innerHTML = "相機啟動失敗！<br>請檢查是否有授權權限，且確認網址為 HTTPS。";
            });

            window.addEventListener('resize', () => {
                canvasElement.width = window.innerWidth;
                canvasElement.height = window.innerHeight;
            });
        });
    </script>
</body>
</html>
